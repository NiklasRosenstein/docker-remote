## docker-remote (WIP)

Docker-remote is a wrapper for `docker-compose` that allows you to manage Docker
compositions on a remote machine easily. It automatically opens an SSH tunnel
for the docker daemon and wraps the `docker` and `docker-compose` commands.

By wrapping `docker-compose`, docker-remote can update your configuration file
to ensure that relative volume paths are converted to absolute paths inside a
project directory on the host.

---

__Host Requirements__

* Docker-CE (not tested with Docker-EE)
* A `root` user with your SSH public key in `/root/.ssh/authorized_keys`
* A system user called `docker-remote` with the docker-remote command-line
  tools installed, optionally with your SSH public key installed in
  `/home/docker-remote/.ssh/authorized_keys`

__Client Requirements__

* An SSH private key installed on the host's `root` account
* The docker-remote command-line tools

---

### Example

A simple web service:

```yaml
# docker-compose.yml
version: '3'
services:
  web:
    build: .
    volumes:
      - data:/app/data
```

Compose the container on your remote host machine:

```
$ docker-remote -p my_project compose up -d
```

Check the running containers:

```
$ docker-remote -p my_project compose ps
         Name                  Command          State     Ports
---------------------------------------------------------------
myproject_web_1          /bin/sh python ...     Up
```

Download the data generated by the containers in the volumes:

```
$ docker-remote -p my_project scp ./output-directory data
```

Also convenient, access to the docker CLI linked to the remote machine:

```
$ docker-remote docker container prune
```

---

### Command-line Usage

```
usage: docker-remote [-h] [-p PROJECT_NAME] [-H HOST] [-v]
              {tunnel,shell,ls,rm,scp,docker,compose} ...

positional arguments:
  {tunnel,shell,ls,rm,scp,docker,compose}
    tunnel              Create a tunnel to a docker daemon.
    shell               Create a tunnel and enter a new shell.
    ls                  List projects on the host.
    rm                  Delete a project on the host.
    scp                 Download a volume or multiple volume directories from
                        the host. If no volumes are specified, the whole
                        project directory is downloaded.
    docker              Wrapper for docker.
    compose             Wrapper for docker compose.

optional arguments:
  -h, --help            show this help message and exit
  -p PROJECT_NAME, --project-name PROJECT_NAME
                        The project name. If this option is omitted, it will
                        be read from the configuration file or fall back on a
                        random project name.
  -H HOST, --host HOST  The name of the Docker host. If this option is
                        omitted, it will be read from the configuration file
                        or fall back on "localhost". In the case of
                        "localhost", no SSH tunnel will be created. This
                        option may include the user in the form of
                        "user@host".
  -v, --verbose         Generate more output, such as sub-commands that are
                        being invoked.
```

### Set-up

On the host machine, create a user called `docker-remote` and install this package.
Also add your SSH public key to the authorized_keys of the `root` and
optionally the `docker-remote` user. If you do not add your public key to the latter,
you will need to specify the password in your client configuration.

    $ sudo nano /root/.ssh/authorized_keys
    $ sudo useradd docker-remote -m --shell /bin/bash -p docker-remote
    $ sudo su docker-remote && cd
    $ pip3 install --user git+https://github.com/NiklasRosenstein/docker-remote.git
    $ docker-remote --version  # Ensure that you can use the command-line tools
    Docker-remote 1.0.0
    $ nano ~/.ssh/authorized_keys

On the client, install the docker-remote command-line tools.

    $ pip3 install --user git+https://github.com/NiklasRosenstein/docker-remote.git
    $ docker-remote --version
    Docker-remote 1.0.0
    $ cat ~/.docker-remote.toml
    [remote]
    host = "myhost.com"  # The name of the host that you installed docker-remote on
    user = "docker-remote"  # Default
    password = "..."  # The password if you did not add your public key
    $ nano docker-compose.yml
    $ docker-remote -p my_project compose up -d  # Compose a container on the remote
    $ docker-remote -p my_project scp data  # Download the volume directories to "./data"

### Configuration

You can place the docker-remote configuration in `~/.docker-remote.toml` and `./docker-remote.toml`.
The local configuration should be used only for a project if you want to use a
different remote configuration or fix the project name.

#### [project] name

The project name. Should only be specified in the local directories'
`docker-remote.toml` configuration file. If no project name is explicitly specified
on the command-line, this value is used.

#### [host] project_root

This is used only on the docker-remote host machine. Defaults to the home directory
of the user through which the docker-remote command-line is called (which is usually
the `docker-remote` user). This is the directory where project directories will be
located. Currently project directories are only used for volumes.

#### [remote] host

The host name of the remote machine. Defaults to `localhost`. In the case of
`localhost`, your machine does not need an SSH server installed.

#### [remote] user

The user name. Not used if `[remote] host` is `localhost`. Defaults to
`docker-remote`. Note that this is independent from the SSH tunnel username option,
which defaults to `root`.

#### [remote] password

The password of the user on the `[remote] host`.

#### [tunnel] remote_user

The username of the remote through which an SSH tunnel to the Docker daemon
should be created. This user is also used for the `docker-remote scp` command for
downloading project data. Defaults to `root`.

#### [tunnel] local_port

The local port to bind the SSH tunnel to. Defaults to `2375`.

#### [tunnel] remote_port

The remote port to bind the SSH tunnel to. Defaults to the
`/var/run/docker.sock` socket file.

---

<p align="center">Copyright &copy; 2018 Niklas Rosenstein</p>
